
<!-- Image section -->

<div class="text-center p-3">
<h1>Welcome to the TELAMON Database!</h1>
<h2>Tev Effelsberg Long-term Agn MONitoring</h2>
</br>
 <div class="row align-items-start">
    <div class="col-md-3">
    </div>
    <div class="col-md-6">
      <%= image_tag("telescope", class: "img-fluid") %>
    </div>
    <div class="col-md-3">
    </div>
  </div>
</br>
</div>

<div class="text-center p-3">
<%= link_to "Overview of monitored sources", sources_path %>
</br>
<%= link_to "Overview of observing epochs", epoches_path %>
</br>
</div>



<!-- Latest news section -->
<div class="card">
  <div class="card-header">
    Latest news
  </div>
  <div class="card-body">
    <h5 class="card-title">Last observation on <%= @epoches.order("date").reverse.first.date %>:</h5>

    <!-- checking for surprising changes in most recent epoch -->
    <% latest_epoch = @epoches.order("date").reverse.first %>
    <% latest_epoch.sources.distinct.each do |source| %>

    	<% epoch_before = source.epoches.distinct.order("date").reverse.second %>

    	<% if(epoch_before != nil) %>

        <% values7 = Array.new %>
        <% values14 = Array.new %>

        <% values7_before = Array.new %>
        <% values14_before = Array.new %>

    		<% source.frequencies.distinct.each do |freq| %>

    			<% value_now = @results.where(:epoch_id => latest_epoch.id, :frequency_id => freq.id, :source_id => source.id).average(:value_jy)%>
    			<% value_before = @results.where(:epoch_id => epoch_before.id, :frequency_id => freq.id, :source_id => source.id).average(:value_jy)%>

          <%if value_before != nil and value_now != nil %>
            <% if freq.freq_ghz >19 and freq.freq_ghz<25 %>
              <% values14.push(value_now)%>
              <% values14_before.push(value_before)%>
            <% elsif freq.freq_ghz >36 and freq.freq_ghz<44%>
              <% values7.push(value_now)%>
              <% values7_before.push(value_before)%>
            <% end %>
          <% end %>
    		<%end%>

        <% aver14=values14.inject(0.0) { |sum, el| sum + el } / values14.size %>        
        <% aver14_before=values14_before.inject(0.0) { |sum, el| sum + el } / values14_before.size %>


        <% aver7=values7.inject(0.0) { |sum, el| sum + el } / values7.size %>
        <% aver7_before=values7_before.inject(0.0) { |sum, el| sum + el } / values7_before.size %>
        

        <% if aver14>1.1*aver14_before and aver7>1.1*aver7_before%>
          <%= link_to source.j2000_name, source %> increased by <%= (((aver14+aver7) / (aver14_before+aver7_before) - 1)*100).round.to_s%>%  at 7mm and 14mm compared to last detection on <%= epoch_before.date %> <br/>
        <% else %>
          <% if aver14>1.1*aver14_before %>
            <%= link_to source.j2000_name, source %> increased by <%= ((aver14 / aver14_before - 1)*100).round.to_s%>%  at 14mm compared to last detection on <%= epoch_before.date %> <br/>
          <% end%>
          <% if aver7>1.1*aver7_before %>
            <%= link_to source.j2000_name, source %> increased by <%= ((aver7 / aver7_before - 1)*100).round.to_s%>%  at 7mm compared to last detection on <%= epoch_before.date %> <br/>
          <% end%>
        <% end %>

        <% if aver14<0.9*aver14_before and aver7<0.9*aver7_before %>
          <%= link_to source.j2000_name, source %> decreased by <%= (((aver7_before+aver14_before) / (aver14+aver7) - 1)*100).round.to_s%>%  at 7mm and 14mm compared to last detection on <%= epoch_before.date %> <br/>
        <% else %>
          <% if aver14<0.9*aver14_before %>
            <%= link_to source.j2000_name, source %> decreased by <%= ((aver14_before / aver14 - 1)*100).round.to_s%>%  at 14mm compared to last detection on <%= epoch_before.date %> <br/>  
          <% end %>      
          <% if aver7<0.9*aver7_before %>
            <%= link_to source.j2000_name, source %> decreased by <%= ((aver7_before / aver7 - 1)*100).round.to_s%>% at 7mm compared to last detection on <%= epoch_before.date %> <br/>
          <% end %>
        <% end %>

      <%end%>
    <%end%>
  </div>
</div>